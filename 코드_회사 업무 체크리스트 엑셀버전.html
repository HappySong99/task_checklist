<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÜ°ÎåÄÎ¶¨Ïùò ÏóÖÎ¨¥ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</title>
    
    <!-- 1. Ïä§ÌÉÄÏùº ÎèÑÍµ¨ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Î¶¨Ïï°Ìä∏ Î∞è ÏïÑÏù¥ÏΩò ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons (Latest) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        /* Ïª§Ïä§ÌÖÄ Ïä§ÌÅ¨Î°§Î∞î */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 transition-colors duration-300">
    <div id="root"></div>

    <!-- 3. Î©îÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏΩîÎìú -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- ÏïÑÏù¥ÏΩò Ïª¥Ìè¨ÎÑåÌä∏ ÎßµÌçº (Lucide) ---
        const LucideIcon = ({ name, size = 24, className = "", ...props }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    const { icons, createElement } = window.lucide;
                    const iconDef = icons[name];
                    if (iconDef) {
                        const svg = createElement(iconDef);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', className);
                        iconRef.current.innerHTML = '';
                        iconRef.current.appendChild(svg);
                    } else {
                        console.warn(`Icon "${name}" not found.`);
                    }
                }
            }, [name, size, className]);
            return <span ref={iconRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }} {...props} />;
        };

        // ÏïÑÏù¥ÏΩò Ï†ïÏùò
        const CheckCircle2 = (p) => <LucideIcon name="CheckCircle2" {...p} />;
        const Circle = (p) => <LucideIcon name="Circle" {...p} />;
        const Plus = (p) => <LucideIcon name="Plus" {...p} />;
        const Trash2 = (p) => <LucideIcon name="Trash2" {...p} />;
        const Briefcase = (p) => <LucideIcon name="Briefcase" {...p} />;
        const BarChart3 = (p) => <LucideIcon name="BarChart3" {...p} />;
        const AlertCircle = (p) => <LucideIcon name="AlertCircle" {...p} />;
        const FileText = (p) => <LucideIcon name="FileText" {...p} />;
        const Search = (p) => <LucideIcon name="Search" {...p} />;
        const Edit2 = (p) => <LucideIcon name="Edit2" {...p} />;
        const Save = (p) => <LucideIcon name="Save" {...p} />;
        const X = (p) => <LucideIcon name="X" {...p} />;
        const AlertTriangle = (p) => <LucideIcon name="AlertTriangle" {...p} />;
        const Clock = (p) => <LucideIcon name="Clock" {...p} />;
        const Download = (p) => <LucideIcon name="Download" {...p} />;
        const Archive = (p) => <LucideIcon name="Archive" {...p} />;
        const List = (p) => <LucideIcon name="List" {...p} />;
        const CheckSquare = (p) => <LucideIcon name="CheckSquare" {...p} />;
        const TrendingUp = (p) => <LucideIcon name="TrendingUp" {...p} />;
        const Settings = (p) => <LucideIcon name="Settings" {...p} />;
        const History = (p) => <LucideIcon name="History" {...p} />;
        const ArrowRightCircle = (p) => <LucideIcon name="ArrowRightCircle" {...p} />;
        const Eye = (p) => <LucideIcon name="Eye" {...p} />;
        const MessageSquare = (p) => <LucideIcon name="MessageSquare" {...p} />;
        const Layers = (p) => <LucideIcon name="Layers" {...p} />;
        const FileJson = (p) => <LucideIcon name="FileJson" {...p} />;
        const Copy = (p) => <LucideIcon name="Copy" {...p} />;
        const Hash = (p) => <LucideIcon name="Hash" {...p} />;
        const Bookmark = (p) => <LucideIcon name="Bookmark" {...p} />;
        const Moon = (p) => <LucideIcon name="Moon" {...p} />;
        const Sun = (p) => <LucideIcon name="Sun" {...p} />;
        const Check = (p) => <LucideIcon name="Check" {...p} />;
        const ChevronUp = (p) => <LucideIcon name="ChevronUp" {...p} />;
        const ChevronRight = (p) => <LucideIcon name="ChevronRight" {...p} />;
        const RefreshCw = (p) => <LucideIcon name="RefreshCw" {...p} />;
        const Filter = (p) => <LucideIcon name="Filter" {...p} />;
        const CalendarRange = (p) => <LucideIcon name="CalendarRange" {...p} />;
        const ClipboardList = (p) => <LucideIcon name="ClipboardList" {...p} />;
        const Repeat = (p) => <LucideIcon name="Repeat" {...p} />;
        const Undo2 = (p) => <LucideIcon name="Undo2" {...p} />;
        const Redo2 = (p) => <LucideIcon name="Redo2" {...p} />;
        const User = (p) => <LucideIcon name="User" {...p} />;
        const ExternalLink = (p) => <LucideIcon name="ExternalLink" {...p} />;
        const Timer = (p) => <LucideIcon name="Timer" {...p} />;
        const Play = (p) => <LucideIcon name="Play" {...p} />;
        const LayoutGrid = (p) => <LucideIcon name="LayoutGrid" {...p} />;
        const Kanban = (p) => <LucideIcon name="Kanban" {...p} />;
        const Calendar = (p) => <LucideIcon name="Calendar" {...p} />;
        const Bell = (p) => <LucideIcon name="Bell" {...p} />;
        const Grid = (p) => <LucideIcon name="Grid" {...p} />;
        const Upload = (p) => <LucideIcon name="Upload" {...p} />;
        const FileCode = (p) => <LucideIcon name="FileCode" {...p} />;
        const ArrowUp = (p) => <LucideIcon name="ArrowUp" {...p} />;
        const ArrowDown = (p) => <LucideIcon name="ArrowDown" {...p} />;

        // ----------------------------------------------------------------------
        // App Component
        // ----------------------------------------------------------------------

        function App() {
            // --- ÌÖåÎßà Í¥ÄÎ¶¨ ---
            const [theme, setTheme] = useState(() => localStorage.getItem('businessTasks_theme_v2') || 'light');
            useEffect(() => {
                localStorage.setItem('businessTasks_theme_v2', theme);
                const root = document.documentElement;
                root.classList.remove('dark', 'excel-theme');
                if (theme === 'dark') root.classList.add('dark');
                if (theme === 'excel') root.classList.add('excel-theme');
            }, [theme]);

            const getThemeStyles = () => {
                switch (theme) {
                case 'dark':
                    return {
                    bg: 'bg-slate-900 text-slate-100',
                    header: 'bg-slate-800 border-slate-700',
                    card: 'bg-slate-800 border-slate-700',
                    input: 'bg-slate-700 border-slate-600 text-white',
                    buttonPrimary: 'bg-indigo-600 hover:bg-indigo-700 text-white',
                    buttonSecondary: 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600',
                    accent: 'text-indigo-400',
                    muted: 'text-slate-400',
                    border: 'border-slate-700'
                    };
                case 'excel':
                    return {
                    bg: 'bg-gray-100 text-gray-900 font-mono',
                    header: 'bg-[#107C41] border-[#107C41] text-white shadow-md rounded-none',
                    card: 'bg-white border-gray-300 rounded-none shadow-sm',
                    input: 'bg-white border-gray-400 text-gray-900 rounded-none focus:ring-[#107C41]',
                    buttonPrimary: 'bg-[#107C41] hover:bg-[#0c5d31] text-white rounded-none',
                    buttonSecondary: 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50 rounded-none',
                    accent: 'text-[#107C41]',
                    muted: 'text-gray-500',
                    border: 'border-gray-300'
                    };
                default:
                    return {
                    bg: 'bg-slate-100 text-slate-800',
                    header: 'bg-white border-slate-200',
                    card: 'bg-white border-slate-200',
                    input: 'bg-white border-slate-300 text-slate-700',
                    buttonPrimary: 'bg-indigo-600 hover:bg-indigo-700 text-white',
                    buttonSecondary: 'bg-white border-slate-300 text-slate-700 hover:bg-slate-50',
                    accent: 'text-indigo-600',
                    muted: 'text-slate-500',
                    border: 'border-slate-200'
                    };
                }
            };
            const ts = getThemeStyles();

            const toggleTheme = () => {
                if (theme === 'light') setTheme('dark');
                else if (theme === 'dark') setTheme('excel');
                else setTheme('light');
            };

            // --- Toast ---
            const [toasts, setToasts] = useState([]);
            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000); 
            };

            // --- Data ---
            const defaultCategories = ['Î≥¥Í≥†', 'Ï†ÄÏû•Ìíà', 'ÏàòÏÑ†Ïú†ÏßÄÎπÑ', 'ÏÜåÎ™®Ìíà', 'Í¥ÄÎ¶¨Ï†ÑÌôò', 'Í∏∞ÌÉÄ'];
            const [categories, setCategories] = useState(() => JSON.parse(localStorage.getItem('businessTasks_categories')) || defaultCategories);
            
            const defaultTemplates = [
                { id: 't1', title: 'ÏõîÍ∞Ñ ÎπÑÏö© ÌíàÏùò', text: '[ÏõîÍ∞Ñ] 00Ïõî Î∂ÄÏÑú Ïö¥ÏòÅÎπÑ ÌíàÏùò', category: 'ÏÜåÎ™®Ìíà', priority: 'high', subtasks: [{id:1, text: 'ÏòÅÏàòÏ¶ù Ï∑®Ìï©', done:false}, {id:2, text: 'ERP ÏûÖÎ†•', done:false}] },
                { id: 't2', title: 'Ï£ºÍ∞Ñ ÏóÖÎ¨¥ Î≥¥Í≥†', text: '[Ï£ºÍ∞Ñ] 00Ïõî 0Ï£ºÏ∞® ÏóÖÎ¨¥ Î≥¥Í≥†', category: 'Î≥¥Í≥†', priority: 'medium', subtasks: [] }
            ];
            const [templates, setTemplates] = useState(() => JSON.parse(localStorage.getItem('businessTasks_templates')) || defaultTemplates);

            const getTodayString = () => new Date().toISOString().split('T')[0];

            const initialTasks = [
                { 
                id: 1, 
                text: '3Î∂ÑÍ∏∞ Ï†ïÍ∏∞ ÏÜåÎ™®Ìíà Íµ¨Îß§', 
                category: 'ÏÜåÎ™®Ìíà', 
                priority: 'high', 
                status: 'in_progress', 
                startDate: '2024-06-20',
                deadline: '2024-06-25',
                completedAt: null,
                tags: ['#Ï†ïÍ∏∞Íµ¨Îß§', '#ÏòàÏÇ∞Í¥ÄÎ¶¨'],
                subtasks: [
                    { id: 101, text: 'Î∂ÄÏÑúÎ≥Ñ ÏàòÏöîÏ°∞ÏÇ¨', done: true, targetDate: '' },
                    { id: 102, text: 'Í≤¨Ï†ÅÏÑú ÎπÑÍµê', done: false, targetDate: getTodayString() }, 
                    { id: 103, text: 'ÌíàÏùò ÏÉÅÏã†', done: false, targetDate: '' }
                ],
                comments: [
                    { id: 901, author: 'Í¥ÄÎ¶¨Ïûê', text: 'Í≤¨Ï†ÅÏÑú ÏóÖÏ≤¥ 3Í≥≥ Ïù¥ÏÉÅ ÎπÑÍµêÌñàÎÇò?', date: '2024-06-21 14:00' }
                ],
                notes: 'ÌåÄÏû•Îãò Í≤∞Ïû¨ ÎåÄÍ∏∞ Ï§ë',
                isArchived: false,
                recurrence: 'none'
                }
            ];

            const [tasks, setTasks] = useState(() => {
                const saved = localStorage.getItem('businessTasks_v18_6'); 
                return saved ? JSON.parse(saved) : initialTasks;
            });
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('businessTasks_logs')) || []);
            
            // History
            const [history, setHistory] = useState([]);
            const [future, setFuture] = useState([]); 

            // Form States
            const [newTask, setNewTask] = useState('');
            const [category, setCategory] = useState('Î≥¥Í≥†'); 
            const [priority, setPriority] = useState('medium');
            const [startDate, setStartDate] = useState(getTodayString());
            const [deadline, setDeadline] = useState('');
            const [notes, setNotes] = useState('');
            const [newTag, setNewTag] = useState(''); 
            const [tags, setTags] = useState([]); 
            const [recurrence, setRecurrence] = useState('none');
            const [assignee, setAssignee] = useState(''); 
            
            const [newSubtaskText, setNewSubtaskText] = useState('');
            const [editTagInput, setEditTagInput] = useState('');

            // UI Control
            const [filter, setFilter] = useState('all');
            const [priorityFilter, setPriorityFilter] = useState('all'); 
            const [dateRangeFilter, setDateRangeFilter] = useState({ start: '', end: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [errorMsg, setErrorMsg] = useState(''); 
            const [viewMode, setViewMode] = useState('list'); 
            const [groupBy, setGroupBy] = useState('none'); 
            const [showSettings, setShowSettings] = useState(false); 
            const [showLogs, setShowLogs] = useState(false); 
            const [showDashboard, setShowDashboard] = useState(true); 
            const [newCategory, setNewCategory] = useState(''); 
            const [showTemplates, setShowTemplates] = useState(false); 
            const [showArchived, setShowArchived] = useState(false); 
            const [selectedTaskIds, setSelectedTaskIds] = useState([]); 
            const [showReportModal, setShowReportModal] = useState(false); 
            const [expandedTaskIds, setExpandedTaskIds] = useState([]);

            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, title: '', message: '', onConfirm: null });

            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);
            
            // Edit States
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [editSubtaskText, setEditSubtaskText] = useState('');
            const [editCommentText, setEditCommentText] = useState('');
            const [editTagAddInput, setEditTagAddInput] = useState('');

            // Persistence
            useEffect(() => { localStorage.setItem('businessTasks_v18_6', JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem('businessTasks_categories', JSON.stringify(categories)); }, [categories]);
            useEffect(() => { localStorage.setItem('businessTasks_logs', JSON.stringify(logs)); }, [logs]);
            useEffect(() => { localStorage.setItem('businessTasks_templates', JSON.stringify(templates)); }, [templates]);

            // Notifications
            useEffect(() => {
                const today = getTodayString();
                let alertCount = 0;
                tasks.forEach(task => {
                if (task.status === 'completed' || task.isArchived) return;
                const dueSubtasks = task.subtasks?.filter(s => !s.done && s.targetDate === today) || [];
                if (dueSubtasks.length > 0) {
                    dueSubtasks.forEach(sub => {
                    setTimeout(() => { showToast(`üîî [Ïò§Îäò ÏòàÏ†ï] ${task.text} > ${sub.text}`, 'info'); }, alertCount * 500 + 1000);
                    alertCount++;
                    });
                }
                });
            }, []); 

            useEffect(() => { if (errorMsg) { const t = setTimeout(() => setErrorMsg(''), 3000); return () => clearTimeout(t); } }, [errorMsg]);

            const addLog = (action, details) => setLogs(prev => [{id: Date.now(), timestamp: new Date().toLocaleString(), action, details}, ...prev].slice(0, 50));
            const addToHistory = () => { setHistory(prev => { const newHistory = [...prev, tasks]; return newHistory.slice(-20); }); setFuture([]); };

            const handleUndo = useCallback(() => {
                if (history.length === 0) { showToast('ÎêòÎèåÎ¶¥ ÏûëÏóÖÏù¥ ÏóÜÏäµÎãàÎã§.', 'error'); return; }
                const previousTasks = history[history.length - 1];
                setFuture(prev => [...prev, tasks]); setTasks(previousTasks); setHistory(prev => prev.slice(0, -1));
                showToast('Ïù¥Ï†Ñ ÏÉÅÌÉúÎ°ú ÎêòÎèåÎ†∏ÏäµÎãàÎã§.'); addLog('Ïã§Ìñâ Ï∑®ÏÜå', 'Ïù¥Ï†Ñ ÏÉÅÌÉúÎ°ú Î≥µÍµ¨Îê®');
            }, [history, tasks]);

            const handleRedo = useCallback(() => {
                if (future.length === 0) { showToast('Îã§Ïãú Ïã§ÌñâÌï† ÏûëÏóÖÏù¥ ÏóÜÏäµÎãàÎã§.', 'error'); return; }
                const nextTasks = future[future.length - 1];
                setHistory(prev => [...prev, tasks]); setTasks(nextTasks); setFuture(prev => prev.slice(0, -1));
                showToast('ÏûëÏóÖÏùÑ Îã§Ïãú Ïã§ÌñâÌñàÏäµÎãàÎã§.'); addLog('Îã§Ïãú Ïã§Ìñâ', 'ÏûëÏóÖ Î≥µÍµ¨Îê®');
            }, [future, tasks]);

            useEffect(() => {
                const handleKeyDown = (e) => { if ((e.metaKey || e.ctrlKey)) { if (e.key === 'z') { e.preventDefault(); e.shiftKey ? handleRedo() : handleUndo(); } else if (e.key === 'y') { e.preventDefault(); handleRedo(); } } };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [handleUndo, handleRedo]);

            const openConfirm = (title, message, onConfirmAction) => { setConfirmDialog({ isOpen: true, title, message, onConfirm: onConfirmAction }); };
            const closeConfirm = () => { setConfirmDialog({ isOpen: false, title: '', message: '', onConfirm: null }); };
            const handleConfirmAction = () => { if (confirmDialog.onConfirm) confirmDialog.onConfirm(); closeConfirm(); };

            const getNextAction = (task) => {
                if (!task.subtasks || task.subtasks.length === 0) return null;
                const nextSub = task.subtasks.find(s => !s.done);
                if (!nextSub) return "Î™®Îì† ÌïòÏúÑ ÏóÖÎ¨¥ ÏôÑÎ£å";
                if (nextSub.targetDate) {
                const today = getTodayString();
                const dateLabel = nextSub.targetDate === today ? 'Ïò§Îäò' : nextSub.targetDate.substring(5); 
                return `${nextSub.text} (${dateLabel})`;
                }
                return nextSub.text;
            };
            
            const toggleExpand = (id) => {
                setExpandedTaskIds(prev => 
                prev.includes(id) ? prev.filter(tid => tid !== id) : [...prev, id]
                );
            };

            // --- Business Logic ---
            const validateDates = (start, end) => {
                if (start && end && new Date(start) > new Date(end)) { showToast('ÏãúÏûëÏùºÏûêÍ∞Ä ÎßàÍ∞êÏùºÎ≥¥Îã§ Îä¶ÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error'); return false; }
                return true;
            };
            const setDatePreset = (type) => {
                const today = new Date(); const s = today.toISOString().split('T')[0]; setStartDate(s); 
                const t = new Date();
                if(type==='week') t.setDate(t.getDate()+7);
                if(type==='month') t.setMonth(t.getMonth()+1);
                setDeadline(t.toISOString().split('T')[0]);
            };
            const getAutoSubtasks = (cat, baseId) => {
                if (['Ï†ÄÏû•Ìíà', 'ÏàòÏÑ†Ïú†ÏßÄÎπÑ', 'ÏÜåÎ™®Ìíà'].includes(cat)) {
                    return [{id:baseId+1, text:'Í≥ÑÌöçÎ≥¥Í≥†', done:false, targetDate:''}, {id:baseId+2, text:'Î¨ºÌíàÏûÖÍ≥†', done:false, targetDate:''}, {id:baseId+3, text:'Í≤ÄÏàòÎ∞èÏôÑÎ£å', done:false, targetDate:''}, {id:baseId+4, text:'ÎåÄÍ∏àÏßÄÍ∏â', done:false, targetDate:''}];
                } else if (cat === 'Í¥ÄÎ¶¨Ï†ÑÌôò') {
                    return [{id:baseId+1, text:'ÎÇ¥Ïö©Í≥µÏú†', done:false, targetDate:''}, {id:baseId+2, text:'Î¨ºÌíàÏûÖÍ≥†', done:false, targetDate:''}];
                }
                return [];
            };
            const createRecurringTask = (originalTask) => {
                const nextStart = new Date(originalTask.startDate); const nextDead = new Date(originalTask.deadline);
                if (originalTask.recurrence === 'daily') { nextStart.setDate(nextStart.getDate()+1); nextDead.setDate(nextDead.getDate()+1); }
                else if (originalTask.recurrence === 'weekly') { nextStart.setDate(nextStart.getDate()+7); nextDead.setDate(nextDead.getDate()+7); }
                else if (originalTask.recurrence === 'monthly') { nextStart.setMonth(nextStart.getMonth()+1); nextDead.setMonth(nextDead.getMonth()+1); }
                else return null;
                const baseId = Date.now();
                return { ...originalTask, id: baseId, status: 'in_progress', completedAt: null, isArchived: false, startDate: nextStart.toISOString().split('T')[0], deadline: nextDead.toISOString().split('T')[0], text: originalTask.text, subtasks: getAutoSubtasks(originalTask.category, baseId), comments: [] };
            };

            const changeStatus = (id, currentStatus) => {
                addToHistory();
                const nextStatus = currentStatus === 'in_progress' ? 'completed' : 'in_progress';
                const nowStr = new Date().toISOString().split('T')[0];
                let newTasks = tasks.map(t => t.id === id ? { ...t, status: nextStatus, completedAt: nextStatus === 'completed' ? nowStr : null } : t);
                const targetTask = tasks.find(t => t.id === id);
                if (nextStatus === 'completed' && targetTask && targetTask.recurrence !== 'none') {
                    const nextTask = createRecurringTask(targetTask);
                    if (nextTask) { newTasks = [nextTask, ...newTasks]; showToast(`Î∞òÎ≥µ ÏóÖÎ¨¥ ÏÉùÏÑ±: ${targetTask.recurrence}`); addLog('ÏûêÎèô ÏÉùÏÑ±', `Î∞òÎ≥µ ÏóÖÎ¨¥ "${nextTask.text}" ÏÉùÏÑ±Îê®`); }
                }
                setTasks(newTasks);
                addLog('ÏÉÅÌÉú Î≥ÄÍ≤Ω', `"${targetTask.text}": ${currentStatus} -> ${nextStatus}`);
            };

            const toggleSubtaskDirect = (taskId, subId) => {
                addToHistory();
                setTasks(tasks.map(task => {
                if (task.id === taskId) {
                    return { ...task, subtasks: task.subtasks.map(s => s.id === subId ? { ...s, done: !s.done } : s) };
                }
                return task;
                }));
            };

            // --- Bulk & Utils ---
            const toggleSelectTask = (id) => setSelectedTaskIds(prev => prev.includes(id) ? prev.filter(tid => tid !== id) : [...prev, id]);
            const toggleSelectAll = (filteredTasks) => setSelectedTaskIds(selectedTaskIds.length === filteredTasks.length && filteredTasks.length > 0 ? [] : filteredTasks.map(t => t.id));
            const handleBulkStatusChange = (newStatus) => {
                if (selectedTaskIds.length === 0) return;
                addToHistory();
                const nowStr = new Date().toISOString().split('T')[0];
                setTasks(tasks.map(t => selectedTaskIds.includes(t.id) ? { ...t, status: newStatus, completedAt: newStatus === 'completed' ? nowStr : null } : t));
                addLog('ÏùºÍ¥Ñ Î≥ÄÍ≤Ω', `${selectedTaskIds.length}Í±¥ ÏÉÅÌÉú Î≥ÄÍ≤Ω`); showToast(`${selectedTaskIds.length}Í±¥ Ï≤òÎ¶¨ ÏôÑÎ£å`); setSelectedTaskIds([]);
            };
            const handleBulkArchive = () => {
                if (selectedTaskIds.length === 0) return;
                openConfirm('ÏùºÍ¥Ñ Î≥¥Í¥Ä', `ÏÑ†ÌÉùÌïú ${selectedTaskIds.length}Í±¥ÏùÑ Î≥¥Í¥ÄÌï®ÏúºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, () => {
                addToHistory(); setTasks(tasks.map(t => selectedTaskIds.includes(t.id) ? { ...t, isArchived: true } : t));
                addLog('ÏùºÍ¥Ñ Î≥¥Í¥Ä', `${selectedTaskIds.length}Í±¥ Î≥¥Í¥ÄÌï® Ïù¥Îèô`); showToast(`${selectedTaskIds.length}Í±¥ Î≥¥Í¥ÄÎê®`); setSelectedTaskIds([]);
                });
            };

            // --- CSV Import/Export ---
            const exportToCSV = () => {
                if(!tasks.length) { showToast('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error'); return; }
                let c = "ID,Task,Category,Priority,Status,Start,End,DoneAt,Tags,Notes,Subtasks\n";
                tasks.forEach(t=> {
                const subtaskStr = t.subtasks ? t.subtasks.map(s => `${s.text}(${s.targetDate||'-'})`).join('; ') : '';
                c+=`${t.id},"${t.text.replace(/"/g,'""')}",${t.category},${t.priority},${t.status},${t.startDate},${t.deadline},${t.completedAt||''},"${(t.tags||[]).join(' ')}","${(t.notes || '').replace(/"/g, '""')}","${subtaskStr}"\n`;
                });
                const b = new Blob(["\uFEFF"+c], {type:'text/csv;charset=utf-8'});
                const u = URL.createObjectURL(b); const link = document.createElement("a"); link.href=u; link.download="tasks.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                showToast('CSV Îã§Ïö¥Î°úÎìú ÏôÑÎ£å');
            };

            const handleCsvUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                const text = evt.target.result;
                const rows = text.split('\n').slice(1);
                const importedTasks = [];
                
                rows.forEach(row => {
                    if (!row.trim()) return;
                    const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    if (cols.length >= 2) {
                    const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/""/g, '"') : '';
                    const task = {
                        id: Date.now() + Math.random(),
                        text: clean(cols[1]),
                        category: clean(cols[2]) || 'Í∏∞ÌÉÄ',
                        priority: clean(cols[3]) || 'medium',
                        status: clean(cols[4]) === 'completed' ? 'completed' : 'in_progress',
                        startDate: clean(cols[5]) || getTodayString(),
                        deadline: clean(cols[6]) || getTodayString(),
                        completedAt: clean(cols[7]) || null,
                        tags: clean(cols[8]) ? clean(cols[8]).split(' ') : [],
                        notes: clean(cols[9]) || '',
                        subtasks: [],
                        comments: [],
                        isArchived: false,
                        recurrence: 'none'
                    };
                    importedTasks.push(task);
                    }
                });
                
                if (importedTasks.length > 0) {
                    openConfirm('CSV Í∞ÄÏ†∏Ïò§Í∏∞', `${importedTasks.length}Í±¥Ïùò Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§. Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, () => {
                    addToHistory();
                    setTasks(prev => [...importedTasks, ...prev]);
                    showToast(`${importedTasks.length}Í±¥ Í∞ÄÏ†∏Ïò§Í∏∞ ÏÑ±Í≥µ`);
                    addLog('Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞', 'CSV ÌååÏùº Î≥ëÌï©');
                    });
                } else {
                    showToast('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                }
                e.target.value = '';
                };
                reader.readAsText(file);
            };

            // HTML Export (New)
            const exportToHTML = () => {
                if(!tasks.length) { showToast('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error'); return; }
                
                // Construct HTML content
                const htmlContent = `
            <!DOCTYPE html>
            <html lang="ko">
            <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ÏóÖÎ¨¥ Î¶¨Ïä§Ìä∏ Î≥¥Í≥†ÏÑú</title>
            <script src="https://cdn.tailwindcss.com"><\/script>
            <style>
                body { font-family: 'Malgun Gothic', sans-serif; }
                @media print {
                .no-print { display: none; }
                }
            </style>
            </head>
            <body class="bg-gray-100 p-8">
            <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="p-6 bg-indigo-600 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">ÏóÖÎ¨¥ Î¶¨Ïä§Ìä∏ Î≥¥Í≥†ÏÑú</h1>
                    <p class="text-sm opacity-80">Ï∂úÎ†•Ïùº: ${new Date().toLocaleDateString()}</p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold">Ï¥ù ${tasks.length}Í±¥</p>
                    <p class="text-sm opacity-80">ÏßÑÌñâÏ§ë: ${tasks.filter(t=>t.status==='in_progress').length} | ÏôÑÎ£å: ${tasks.filter(t=>t.status==='completed').length}</p>
                </div>
                </div>
                
                <div class="p-6">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">ÏÉÅÌÉú</th>
                        <th scope="col" class="px-6 py-3">Ïö∞ÏÑ†ÏàúÏúÑ</th>
                        <th scope="col" class="px-6 py-3">ÏóÖÎ¨¥Î™Ö</th>
                        <th scope="col" class="px-6 py-3">Îã¥ÎãπÏûê/Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                        <th scope="col" class="px-6 py-3">ÎßàÍ∞êÏùº</th>
                        <th scope="col" class="px-6 py-3">ÎπÑÍ≥†</th>
                    </tr>
                    </thead>
                    <tbody>
                    ${tasks.map(t => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-bold ${t.status==='completed' ? 'text-green-600' : 'text-blue-600'}">
                            ${t.status === 'completed' ? 'ÏôÑÎ£å' : 'ÏßÑÌñâ Ï§ë'}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium 
                            ${t.priority==='high' ? 'bg-red-100 text-red-800' : t.priority==='medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                            ${t.priority.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900">
                            ${t.text}
                            ${t.tags && t.tags.length > 0 ? `<br/><span class="text-xs text-gray-400">${t.tags.join(' ')}</span>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            ${t.assignee || 'ÎØ∏ÏßÄÏ†ï'}<br/>
                            <span class="text-xs text-gray-400">${t.category}</span>
                        </td>
                        <td class="px-6 py-4">
                            ${t.deadline}
                        </td>
                        <td class="px-6 py-4 truncate max-w-xs" title="${t.notes || ''}">
                            ${t.notes || '-'}
                        </td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
                </div>
                
                <div class="p-6 bg-gray-50 border-t border-gray-200 text-center text-xs text-gray-500 no-print">
                <button onclick="window.print()" class="px-4 py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">Ïù∏ÏáÑ / PDF Ï†ÄÏû•</button>
                <p class="mt-2">Business Task Manager Generated Report</p>
                </div>
            </div>
            </body>
            </html>
                `;

                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Tasks_Report_${new Date().toISOString().slice(0,10)}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('HTML Î≥¥Í≥†ÏÑú Îã§Ïö¥Î°úÎìú ÏôÑÎ£å');
            };

            // --- Handlers ---
            const handleAddTag = () => { if (newTag.trim() && !tags.includes(newTag.trim())) { setTags([...tags, newTag.trim()]); } setNewTag(''); };
            const removeTag = (tag) => { setTags(tags.filter(t => t !== tag)); };
            const handleAddEditTag = () => { if (editTagAddInput.trim() && !editForm.tags?.includes(editTagAddInput.trim())) { setEditForm({...editForm, tags: [...(editForm.tags||[]), editTagAddInput.trim()]}); } setEditTagAddInput(''); };
            const removeEditTag = (tag) => { setEditForm({...editForm, tags: (editForm.tags || []).filter(t => t !== tag)}); };
            const handleAddCategory = () => { if (newCategory.trim() && !categories.includes(newCategory)) { setCategories([...categories, newCategory]); setNewCategory(''); addLog('ÏÑ§Ï†ï', `Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä: ${newCategory}`); showToast('Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞ÄÎê®'); } };
            const handleDeleteCategory = (cat) => { if (categories.length > 1) { setCategories(categories.filter(c => c !== cat)); addLog('ÏÑ§Ï†ï', `Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†ú: ${cat}`); showToast('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†úÎê®'); } else showToast('ÏµúÏÜå 1Í∞ú ÌïÑÏöî', 'error'); };
            const handleFactoryReset = () => { openConfirm('ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî', 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?', () => { addToHistory(); setTasks([]); setLogs([]); setCategories(defaultCategories); showToast('Ï¥àÍ∏∞ÌôîÎê®'); }); };
            const duplicateTask = (task) => { addToHistory(); const clonedTask = { ...task, id: Date.now(), text: `${task.text} (Î≥µÏÇ¨Î≥∏)`, status: 'in_progress', completedAt: null, isArchived: false, subtasks: task.subtasks ? task.subtasks.map(s => ({...s, done: false})) : [], comments: [] }; setTasks([clonedTask, ...tasks]); addLog('Î≥µÏ†ú', task.text); showToast('Î≥µÏ†úÎê®'); };
            const toggleArchive = (id) => { addToHistory(); setTasks(tasks.map(t => t.id === id ? { ...t, isArchived: !t.isArchived } : t)); showToast('Î≥¥Í¥Ä ÏÉÅÌÉú Î≥ÄÍ≤Ω'); };
            
            // New: Delete Template Handler
            const deleteTemplate = (id) => {
                openConfirm('ÌÖúÌîåÎ¶ø ÏÇ≠Ï†ú', 'Ïù¥ ÌÖúÌîåÎ¶øÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', () => {
                    const newTemplates = templates.filter(t => t.id !== id);
                    setTemplates(newTemplates);
                    showToast('ÌÖúÌîåÎ¶øÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    addLog('ÌÖúÌîåÎ¶ø ÏÇ≠Ï†ú', 'ÌÖúÌîåÎ¶øÏù¥ ÏÇ≠Ï†úÎê®');
                });
            };

            const addTask = (e) => {
                e.preventDefault();
                if (!newTask.trim()) { showToast('ÎÇ¥Ïö© ÏûÖÎ†• ÌïÑÏöî', 'error'); return; }
                addToHistory();
                const baseId = Date.now();
                let autoSubtasks = getAutoSubtasks(category, baseId);
                // Subtask input removed as requested
                const task = { id: baseId, text: newTask, category, priority, status: 'in_progress', startDate: startDate || getTodayString(), deadline: deadline || getTodayString(), completedAt: null, subtasks: autoSubtasks, comments: [], tags: tags, notes: notes, isArchived: false, recurrence: recurrence };
                setTasks([task, ...tasks]); addLog('ÏÉùÏÑ±', newTask); showToast('Îì±Î°ù ÏôÑÎ£å');
                setNewTask(''); setStartDate(getTodayString()); setDeadline(''); setNotes(''); setTags([]); 
            };

            const startEdit = (task) => { setEditingId(task.id); setEditForm({ ...task }); setEditSubtaskText(''); setEditCommentText(''); setEditTagAddInput(''); };
            const cancelEdit = () => { setEditingId(null); setEditForm({}); };
            const saveEdit = () => { addToHistory(); setTasks(tasks.map(t => t.id === editingId ? editForm : t)); addLog('ÏàòÏ†ï', editForm.text); showToast('ÏàòÏ†ï ÏôÑÎ£å'); setEditingId(null); };
            const addSubtaskToEdit = () => { if(editSubtaskText.trim()){ setEditForm({...editForm, subtasks: [...(editForm.subtasks||[]), {id:Date.now(), text:editSubtaskText, done:false, targetDate: editTagInput}]}); setEditSubtaskText(''); } };
            const removeSubtaskFromEdit = (sid) => { setEditForm({...editForm, subtasks: editForm.subtasks.filter(s=>s.id!==sid)}); };
            const toggleSubtaskFromEdit = (sid) => { setEditForm({...editForm, subtasks: editForm.subtasks.map(s=>s.id===sid?{...s,done:!s.done}:s)}); };
            const moveSubtask = (subId, direction) => {
                const subtasks = [...(editForm.subtasks || [])];
                const index = subtasks.findIndex(s => s.id === subId);
                if (index < 0) return;
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < subtasks.length) {
                    [subtasks[index], subtasks[newIndex]] = [subtasks[newIndex], subtasks[index]];
                    setEditForm({ ...editForm, subtasks });
                }
            };
            const addCommentToEdit = () => { if(editCommentText.trim()){ setEditForm({...editForm, comments: [...(editForm.comments||[]), {id:Date.now(), author:'Í¥ÄÎ¶¨Ïûê', text:editCommentText, date:new Date().toLocaleString()}]}); setEditCommentText(''); } };
            const deleteTask = (id) => { openConfirm('ÏÇ≠Ï†ú', 'ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', () => { addToHistory(); setTasks(tasks.filter(t=>t.id!==id)); addLog('ÏÇ≠Ï†ú', 'ÏóÖÎ¨¥ ÏÇ≠Ï†ú'); showToast('ÏÇ≠Ï†ú ÏôÑÎ£å'); }); };
            const clearCompleted = () => { const cnt = tasks.filter(t=>t.status==='completed' && !t.isArchived).length; if(cnt===0) return; openConfirm('Ï†ïÎ¶¨', 'ÏôÑÎ£åÎêú ÏóÖÎ¨¥Î•º Î≥¥Í¥ÄÌï®ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÍπå?', () => { addToHistory(); setTasks(tasks.map(t=>t.status==='completed'?{...t, isArchived:true}:t)); showToast('Î≥¥Í¥Ä ÏôÑÎ£å'); }); };
            const loadTemplate = (tmpl) => { setNewTask(tmpl.text); setCategory(tmpl.category); setPriority(tmpl.priority); setStartDate(getTodayString()); setDatePreset('week'); setShowTemplates(false); showToast('ÌÖúÌîåÎ¶ø Î°úÎìú'); };
            const saveAsTemplate = () => { if(!newTask) return; let t='ÏÉà ÌÖúÌîåÎ¶ø'; try{t=prompt('ÌÖúÌîåÎ¶øÎ™Ö')||t}catch(e){} setTemplates([...templates, {id:Date.now(), title:t, text:newTask, category, priority, subtasks:[]}]); showToast('Ï†ÄÏû•Îê®'); };

            const processedTasks = useMemo(() => {
                return tasks.filter(t => {
                if (showArchived) return t.isArchived;
                if (!showArchived && t.isArchived) return false;
                if (filter !== 'all' && t.status !== filter) return false;
                if (priorityFilter !== 'all' && t.priority !== priorityFilter) return false;
                if (dateRangeFilter.start && t.deadline < dateRangeFilter.start) return false;
                if (dateRangeFilter.end && t.deadline > dateRangeFilter.end) return false;
                if (searchTerm) { const lower = searchTerm.toLowerCase(); return t.text.toLowerCase().includes(lower) || t.notes?.toLowerCase().includes(lower) || t.tags.some(tg=>tg.toLowerCase().includes(lower)); }
                return true;
                }).sort((a,b) => {
                if(a.status === 'completed' && b.status !== 'completed') return 1;
                if(a.status !== 'completed' && b.status === 'completed') return -1;
                if(a.priority === 'high' && b.priority !== 'high') return -1;
                if(a.priority !== 'high' && b.priority === 'high') return 1;
                return 0;
                });
            }, [tasks, filter, priorityFilter, dateRangeFilter, searchTerm, showArchived]);

            const groupedTasks = useMemo(() => {
                if (groupBy === 'none') return { 'Ï†ÑÏ≤¥ ÏóÖÎ¨¥': processedTasks };
                return processedTasks.reduce((acc, t) => {
                let key = t[groupBy];
                if (groupBy === 'status') key = key === 'in_progress' ? 'ÏßÑÌñâ Ï§ë' : 'ÏôÑÎ£å';
                if (!acc[key]) acc[key] = []; acc[key].push(t); return acc;
                }, {});
            }, [processedTasks, groupBy]);

            const stats = useMemo(() => {
                const activeTasks = tasks.filter(t => !t.isArchived);
                const total = activeTasks.length;
                const completed = activeTasks.filter(t => t.status === 'completed').length;
                const progress = total ? Math.round((completed/total)*100) : 0;
                const today = new Date().toISOString().split('T')[0];
                const overdue = activeTasks.filter(t => t.status !== 'completed' && t.deadline < today).length;
                
                // ÏõîÎ≥Ñ Îç∞Ïù¥ÌÑ∞ ÏßëÍ≥Ñ (ÏµúÍ∑º 6Í∞úÏõî)
                const monthlyData = [];
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const key = `${yyyy}-${mm}`;
                    
                    // tasks Ï†ÑÏ≤¥(Î≥¥Í¥ÄÌï® Ìè¨Ìï®)Î•º ÎåÄÏÉÅÏúºÎ°ú Ìï¥Îãπ ÏõîÏóê ÏôÑÎ£åÎêú Í±¥Ïàò ÏßëÍ≥Ñ
                    const count = tasks.filter(t => {
                        if (t.status !== 'completed' || !t.completedAt) return false;
                        return t.completedAt.startsWith(key);
                    }).length;
                    
                    monthlyData.push({ month: `${Number(mm)}Ïõî`, count, key });
                }
                
                // ÏµúÎåÄÍ∞í Í≥ÑÏÇ∞ (Í∑∏ÎûòÌîÑ ÎÜíÏù¥ Ï†ïÍ∑úÌôîÏö©)
                const maxMonthlyCount = Math.max(...monthlyData.map(d => d.count), 1); // 0ÏúºÎ°ú ÎÇòÎàÑÍ∏∞ Î∞©ÏßÄ

                return { total, completed, progress, overdue, monthlyData, maxMonthlyCount };
            }, [tasks]);

            const getDday = (d) => {
                const today = new Date(); today.setHours(0,0,0,0); const target = new Date(d); target.setHours(0,0,0,0);
                const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                if (diff < 0) return `D+${Math.abs(diff)}`; if (diff === 0) return 'D-Day'; return `D-${diff}`;
            };
            const getPriorityColor = (p) => {
                const base = isDarkMode ? 'bg-opacity-20 border-opacity-50' : '';
                switch(p) {
                case 'high': return isDarkMode ? `text-red-400 bg-red-900 border-red-800 ${base}` : 'text-red-600 bg-red-50 border-red-200';
                case 'medium': return isDarkMode ? `text-amber-400 bg-amber-900 border-amber-800 ${base}` : 'text-amber-600 bg-amber-50 border-amber-200';
                case 'low': return isDarkMode ? `text-blue-400 bg-blue-900 border-blue-800 ${base}` : 'text-blue-600 bg-blue-50 border-blue-200';
                default: return isDarkMode ? `text-slate-400 bg-slate-800 border-slate-700` : 'text-slate-600 bg-slate-50 border-slate-200';
                }
            };
            const getStatusStyle = (status) => {
                const darkBase = 'border-slate-700';
                if (isDarkMode) {
                if(status==='completed') return `${darkBase} bg-slate-800/50 opacity-60`;
                return `${darkBase} bg-slate-800`; // in_progress
                }
                if(status==='completed') return 'border-slate-100 bg-slate-50 opacity-60';
                return 'border-slate-200 bg-white'; // in_progress
            };
            const getStatusIcon = (status) => {
                if(status==='completed') return <CheckCircle2 className="w-6 h-6 text-indigo-500" />;
                return <Circle className="w-6 h-6 text-slate-300 dark:text-slate-600" />;
            };

            return (
                <div className={`min-h-screen font-sans transition-colors duration-300 ${ts.bg}`}>
                
                <div className="fixed top-4 right-4 z-50 flex flex-col gap-2 no-print">
                    {toasts.map(t => (
                    <div key={t.id} className={`flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border animate-in slide-in-from-right-full ${t.type === 'error' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-indigo-50 border-indigo-200 text-indigo-700'}`}>
                        {t.type === 'error' ? <AlertTriangle className="w-5 h-5"/> : <Check className="w-5 h-5"/>} <span className="text-sm font-bold">{t.message}</span>
                    </div>
                    ))}
                </div>

                {confirmDialog.isOpen && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] animate-in fade-in no-print">
                    <div className={`p-6 rounded-xl shadow-2xl w-full max-w-sm ${ts.card}`}>
                        <h3 className="text-lg font-bold mb-2 flex items-center gap-2 text-red-500"><AlertTriangle className="w-6 h-6"/> {confirmDialog.title}</h3>
                        <p className={`text-sm mb-6 ${ts.muted}`}>{confirmDialog.message}</p>
                        <div className="flex gap-3 justify-end">
                        <button onClick={closeConfirm} className={`px-4 py-2 rounded-lg font-bold ${ts.buttonSecondary}`}>Ï∑®ÏÜå</button>
                        <button onClick={handleConfirmAction} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-lg">ÌôïÏù∏</button>
                        </div>
                    </div>
                    </div>
                )}

                <div className="max-w-[1600px] mx-auto space-y-6 p-2 md:p-8">
                    
                    <header className={`flex flex-col xl:flex-row justify-between items-start xl:items-center p-6 rounded-xl shadow-sm border gap-4 transition-colors no-print ${ts.header}`}>
                    <div className="flex items-center gap-4">
                        <div>
                        <h1 className={`text-2xl font-bold flex items-center gap-2 ${theme === 'excel' ? 'text-white' : ''}`}>
                            <Briefcase className="w-6 h-6" /> ÏÜ°ÎåÄÎ¶¨Ïùò ÏóÖÎ¨¥ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
                        </h1>
                        <p className={`text-sm mt-1 ${theme === 'excel' ? 'text-gray-100' : ts.muted}`}>Import/Export & Theme Selection</p>
                        </div>
                        <button onClick={() => setShowDashboard(!showDashboard)} className={`ml-4 p-2 rounded-lg border transition-all ${theme === 'dark' ? 'border-slate-600 hover:bg-slate-700' : 'border-white/20 hover:bg-white/10'}`}>
                        {showDashboard ? <ChevronUp className="w-5 h-5"/> : <BarChart3 className="w-5 h-5"/>}
                        </button>
                    </div>
                    
                    <div className="flex flex-col md:flex-row gap-4 items-end md:items-center w-full md:w-auto">
                        
                        <div className={`flex items-center p-1 rounded-lg border ${theme === 'dark' ? 'bg-slate-700 border-slate-600' : 'bg-white border-slate-200'}`}>
                        <button onClick={() => setTheme('light')} className={`px-3 py-1 text-xs rounded-md ${theme==='light' ? 'bg-indigo-100 text-indigo-700 font-bold' : 'text-slate-500'}`}>Light</button>
                        <button onClick={() => setTheme('dark')} className={`px-3 py-1 text-xs rounded-md ${theme==='dark' ? 'bg-slate-600 text-white font-bold' : 'text-slate-500'}`}>Dark</button>
                        <button onClick={() => setTheme('excel')} className={`px-3 py-1 text-xs rounded-md ${theme==='excel' ? 'bg-green-100 text-green-700 font-bold' : 'text-slate-500'}`}>Excel</button>
                        </div>

                        <div className={`p-2 rounded-md bg-white shadow text-indigo-600 dark:bg-slate-600`} style={{display: 'none'}}><List className="w-4 h-4" /></div>

                        <div className="flex gap-2">
                        <button onClick={handleUndo} className={`btn-secondary flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium ${ts.buttonSecondary}`} disabled={history.length === 0}><Undo2 className="w-4 h-4" /></button>
                        <button onClick={handleRedo} className={`btn-secondary flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium ${ts.buttonSecondary}`} disabled={future.length === 0}><Redo2 className="w-4 h-4" /></button>
                        <button onClick={() => setShowArchived(!showArchived)} className={`btn-secondary flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium ${ts.buttonSecondary} ${showArchived ? 'text-amber-600 border-amber-200 bg-amber-50' : ''}`}><Archive className="w-4 h-4" /></button>
                        <button onClick={() => setShowLogs(!showLogs)} className={`btn-secondary flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium ${ts.buttonSecondary}`}><History className="w-4 h-4" /></button>
                        <button onClick={() => setShowSettings(!showSettings)} className={`btn-secondary flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium ${ts.buttonSecondary}`}><Settings className="w-4 h-4" /></button>
                        
                        <div className={`flex rounded-lg border overflow-hidden ${theme === 'dark' ? 'border-slate-600' : 'border-slate-200'}`}>
                            <input type="file" accept=".csv" ref={csvInputRef} className="hidden" onChange={handleCsvUpload} />
                            <button onClick={() => csvInputRef.current.click()} className={`px-3 py-2 text-xs flex items-center gap-1 border-r ${theme === 'dark' ? 'bg-slate-700 hover:bg-slate-600 border-slate-600 text-white' : 'bg-white hover:bg-gray-50 border-slate-200 text-slate-700'}`} title="CSV Í∞ÄÏ†∏Ïò§Í∏∞">
                            <Upload className="w-3 h-3"/>
                            </button>
                            <button onClick={exportToCSV} className={`px-3 py-2 text-xs flex items-center gap-1 border-r ${theme === 'dark' ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-slate-800 hover:bg-slate-700 text-white'}`} title="CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞">
                            <Download className="w-3 h-3"/> CSV
                            </button>
                            <button onClick={exportToHTML} className={`px-3 py-2 text-xs flex items-center gap-1 ${theme === 'dark' ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-slate-800 hover:bg-slate-700 text-white'}`} title="HTML Î≥¥Í≥†ÏÑú ÎÇ¥Î≥¥ÎÇ¥Í∏∞">
                            <FileCode className="w-3 h-3"/> HTML
                            </button>
                        </div>
                        </div>
                    </div>
                    </header>

                    {showReportModal && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div className={`p-6 rounded-xl shadow-xl w-full max-w-2xl ${ts.card}`}>
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><ClipboardList className="w-5 h-5"/> Ï£ºÍ∞Ñ ÏóÖÎ¨¥ Î≥¥Í≥† ÏÉùÏÑ±</h3>
                        <div className={`p-4 rounded border font-mono text-xs whitespace-pre-wrap max-h-[60vh] overflow-y-auto mb-4 ${theme === 'dark' ? 'bg-slate-900 border-slate-600' : 'bg-slate-50 border-slate-200'}`}>{generateWeeklyReport()}</div>
                        <div className="flex gap-3"><button onClick={() => setShowReportModal(false)} className={`flex-1 py-2 rounded-lg font-bold ${ts.buttonSecondary}`}>Îã´Í∏∞</button><button onClick={copyReportToClipboard} className={`flex-[2] py-2 rounded-lg font-bold flex items-center justify-center gap-2 ${ts.buttonPrimary}`}><Copy className="w-4 h-4"/> Î≥µÏÇ¨</button></div>
                        </div>
                    </div>
                    )}

                    {showArchived && <div className="bg-amber-100 border border-amber-200 text-amber-800 px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-bold animate-in fade-in"><Archive className="w-4 h-4"/> Î≥¥Í¥ÄÌï® Î™®Îìú</div>}

                    {/* Dashboard */}
                    {showDashboard && !showArchived && (
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3 animate-in fade-in slide-in-from-top-4 duration-300 no-print">
                        {/* Dashboard Item 1: Monthly Trend */}
                        <div className={`p-4 rounded-xl border shadow-sm ${ts.card} col-span-2 md:col-span-1`}>
                            <div className={`text-xs font-medium mb-2 ${ts.muted} flex justify-between`}>
                                <span>ÏõîÎ≥Ñ ÏôÑÎ£å Ïã§Ï†Å (ÏµúÍ∑º 6Í∞úÏõî)</span>
                                <span className="font-bold">{stats.progress}% ÏôÑÎ£å</span>
                            </div>
                            <div className="flex items-end justify-between h-16 gap-1">
                                {stats.monthlyData.map((d) => {
                                     const height = stats.maxMonthlyCount > 0 ? (d.count / stats.maxMonthlyCount) * 100 : 0;
                                     return (
                                         <div key={d.key} className="flex flex-col items-center w-full group relative">
                                            {/* Tooltip */}
                                            <div className="absolute -top-6 text-[10px] font-bold opacity-0 group-hover:opacity-100 transition-opacity bg-black text-white px-1 rounded z-10 whitespace-nowrap">{d.count}Í±¥</div>
                                            <div className={`w-full rounded-t-sm transition-all duration-500 ${theme === 'dark' ? 'bg-indigo-600' : 'bg-indigo-500'}`} style={{ height: `${Math.max(height, 5)}%` }}></div>
                                            <span className="text-[9px] mt-1 opacity-70">{d.month}</span>
                                         </div>
                                     );
                                })}
                            </div>
                        </div>

                        <div className={`p-4 rounded-xl border shadow-sm ${ts.card}`}>
                        <div className={`text-xs font-medium mb-1 ${ts.muted}`}>ÏßÑÌñâ Ï§ë</div>
                        <div className="text-2xl font-bold text-blue-600">{tasks.filter(t=>t.status==='in_progress' && !t.isArchived).length}</div>
                        </div>
                        <div className={`p-4 rounded-xl border shadow-sm ${ts.card}`}>
                        <div className={`text-xs font-medium mb-1 ${ts.muted}`}>ÏßÄÏó∞Îê®</div>
                        <div className="text-2xl font-bold text-red-600">{stats.overdue}</div>
                        </div>
                        <div className={`p-4 rounded-xl border shadow-sm ${ts.card}`}>
                        <div className={`text-xs font-medium mb-1 ${ts.muted}`}>Ï¥ù ÏóÖÎ¨¥</div>
                        <div className="text-2xl font-bold">{stats.total}</div>
                        </div>
                    </div>
                    )}

                    {/* Settings Panel */}
                    {showSettings && (
                    <div className={`p-6 rounded-xl border shadow-lg animate-in fade-in ${ts.card} no-print`}>
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Settings className="w-5 h-5"/> ÏãúÏä§ÌÖú ÏÑ§Ï†ï</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label className={`text-sm font-bold mb-2 block ${ts.muted}`}>Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨</label>
                            <div className="flex gap-2 mb-3">
                            <input type="text" value={newCategory} onChange={(e) => setNewCategory(e.target.value)} placeholder="ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨" className={`flex-1 p-2 border rounded text-sm ${ts.input}`} />
                            <button onClick={handleAddCategory} className={`px-3 py-2 rounded text-xs font-bold ${ts.buttonPrimary}`}>Ï∂îÍ∞Ä</button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                            {categories.map(cat => <span key={cat} className={`px-2 py-1 border rounded-full text-xs flex items-center gap-1 ${ts.border} ${theme==='dark'?'bg-slate-700':'bg-slate-50'}`}>{cat}<button onClick={() => handleDeleteCategory(cat)} className="text-slate-400 hover:text-red-500"><X className="w-3 h-3"/></button></span>)}
                            </div>
                        </div>
                        <div className="space-y-4">
                            <div className={`p-4 rounded border ${theme === 'dark' ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'}`}>
                            <p className={`text-sm font-medium mb-2 ${ts.muted}`}>üí° Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</p>
                            <button onClick={handleFactoryReset} className="px-3 py-1.5 bg-red-600 text-white text-xs rounded font-bold hover:bg-red-700 flex items-center gap-1"><RefreshCw className="w-3 h-3"/> ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî</button>
                            </div>
                        </div>
                        </div>
                    </div>
                    )}
                    
                    {showLogs && (
                    <div className={`p-4 rounded-xl border shadow-inner max-h-60 overflow-y-auto no-print ${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                        <h3 className={`text-sm font-bold mb-2 flex items-center gap-2 ${ts.muted}`}><History className="w-4 h-4"/> ÏµúÍ∑º ÌôúÎèô Î°úÍ∑∏</h3>
                        <ul className="space-y-2">{logs.map(log => <li key={log.id} className={`text-xs flex gap-2 border-b pb-1 last:border-0 ${ts.border}`}><span className="text-slate-500 font-mono min-w-[120px]">{log.timestamp}</span><span className="font-bold text-indigo-500 min-w-[80px]">{log.action}</span><span className="truncate opacity-70">{log.details}</span></li>)}</ul>
                    </div>
                    )}

                    {showTemplates && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div className={`p-6 rounded-xl shadow-xl w-full max-w-lg ${ts.card}`}>
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Copy className="w-5 h-5"/> ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù</h3>
                        <div className="space-y-3 mb-4 max-h-[60vh] overflow-y-auto">
                            {templates.map(tmpl => (
                            <div key={tmpl.id} className={`p-3 border rounded-lg transition-colors group ${ts.border} hover:bg-opacity-80 flex justify-between items-center`}>
                                <div onClick={() => loadTemplate(tmpl)} className="cursor-pointer flex-1">
                                    <div className="font-bold">{tmpl.title}</div><div className={`text-xs ${ts.muted}`}>{tmpl.category} | {tmpl.priority}</div>
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); deleteTemplate(tmpl.id); }} className="text-slate-400 hover:text-red-500 p-2"><Trash2 className="w-4 h-4"/></button>
                            </div>
                            ))}
                        </div>
                        <button onClick={() => setShowTemplates(false)} className={`w-full py-2 rounded-lg font-bold ${ts.buttonSecondary}`}>Îã´Í∏∞</button>
                        </div>
                    </div>
                    )}

                    {/* Control Tower */}
                    <div className={`p-5 rounded-xl shadow-sm border space-y-4 no-print ${ts.card}`}>
                    <div className="flex flex-col md:flex-row gap-4">
                        <div className="relative flex-1">
                        <Search className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                        <input type="text" placeholder="ÏóÖÎ¨¥Î™Ö, ÌÉúÍ∑∏ Í≤ÄÏÉâ..." className={`w-full p-2.5 pl-10 border rounded-lg text-sm ${ts.input}`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                        
                        <div className="flex gap-2 items-center overflow-x-auto pb-2 md:pb-0">
                        <Filter className="w-4 h-4 text-slate-400 flex-shrink-0" />
                        <div className={`h-4 w-px mx-1 ${theme==='dark'?'bg-slate-600':'bg-slate-300'}`}></div>
                        {[{id: 'all', label: 'Ï†ÑÏ≤¥'}, {id: 'high', label: 'ÎÜíÏùå'}, {id: 'medium', label: 'Ï§ëÍ∞Ñ'}, {id: 'low', label: 'ÎÇÆÏùå'}].map(p => (
                            <button key={p.id} onClick={() => setPriorityFilter(p.id)} className={`px-3 py-1.5 text-xs rounded-full border whitespace-nowrap transition-all ${priorityFilter === p.id ? 'bg-indigo-600 text-white border-indigo-600' : ts.buttonSecondary}`}>{p.label}</button>
                        ))}
                        <div className={`flex items-center gap-1 border rounded-full px-2 py-1 ${ts.input}`}>
                            <CalendarRange className="w-3 h-3 text-slate-400"/>
                            <input type="date" value={dateRangeFilter.start} onChange={(e) => setDateRangeFilter({...dateRangeFilter, start: e.target.value})} className="bg-transparent text-xs w-24 focus:outline-none"/>
                            <span className="text-slate-400 text-xs">~</span>
                            <input type="date" value={dateRangeFilter.end} onChange={(e) => setDateRangeFilter({...dateRangeFilter, end: e.target.value})} className="bg-transparent text-xs w-24 focus:outline-none"/>
                            {(dateRangeFilter.start || dateRangeFilter.end) && <button onClick={() => setDateRangeFilter({start:'', end:''})}><X className="w-3 h-3 text-red-400"/></button>}
                        </div>
                        </div>
                    </div>

                    {selectedTaskIds.length > 0 && (
                        <div className={`flex items-center gap-3 p-3 rounded-lg animate-in slide-in-from-top-2 ${theme === 'dark' ? 'bg-indigo-900 border-indigo-700' : 'bg-indigo-50 border-indigo-100'}`}>
                        <span className="text-sm font-bold text-indigo-600 flex items-center gap-2"><CheckSquare className="w-4 h-4"/> {selectedTaskIds.length}Í∞ú</span>
                        <div className="h-4 w-px bg-indigo-200 mx-2"></div>
                        <div className="flex gap-2">
                            <button onClick={() => handleBulkStatusChange('completed')} className={`px-3 py-1 rounded text-xs font-medium ${ts.buttonSecondary}`}>ÏôÑÎ£å</button>
                            <button onClick={handleBulkArchive} className="px-3 py-1 bg-amber-50 border border-amber-200 rounded text-xs font-medium hover:bg-amber-100 text-amber-700">Î≥¥Í¥Ä</button>
                        </div>
                        <button onClick={() => setSelectedTaskIds([])} className="ml-auto text-xs text-slate-400 hover:text-slate-600">Ï∑®ÏÜå</button>
                        </div>
                    )}

                    {!showArchived && (
                        <form onSubmit={addTask} className="flex flex-col gap-3">
                        <div className="flex flex-col md:flex-row gap-3">
                            <input type="text" placeholder="Ïã†Í∑ú ÏóÖÎ¨¥ Î™Ö" className={`flex-[2] p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 font-medium ${ts.input}`} value={newTask} onChange={(e) => setNewTask(e.target.value)} />
                            <div className="flex-1">
                            <select value={category} onChange={(e) => setCategory(e.target.value)} className={`w-full p-2.5 border rounded-lg text-sm ${ts.input}`}>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
                            </div>
                            <div className="flex gap-2">
                            <select value={priority} onChange={(e) => setPriority(e.target.value)} className={`p-2.5 border rounded-lg text-sm ${ts.input}`}><option value="high">ÎÜíÏùå</option><option value="medium">Ï§ëÍ∞Ñ</option><option value="low">ÎÇÆÏùå</option></select>
                            </div>
                        </div>
                        
                        <div className="flex flex-col md:flex-row gap-3">
                            <div className="flex-1 flex gap-2 items-center">
                                <span className={`text-xs font-bold ${ts.muted}`}>ÏãúÏûë:</span>
                                <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className={`flex-1 p-2.5 border rounded-lg text-sm ${ts.input}`} />
                            </div>
                             <div className="flex-1 flex gap-2 items-center">
                                <span className={`text-xs font-bold ${ts.muted}`}>ÎßàÍ∞ê:</span>
                                <input type="date" value={deadline} onChange={(e) => setDeadline(e.target.value)} className={`flex-1 p-2.5 border rounded-lg text-sm ${ts.input}`} />
                            </div>
                             <div className="flex-1 flex gap-2 items-center">
                                <select value={recurrence} onChange={(e) => setRecurrence(e.target.value)} className={`w-full p-2.5 border rounded-lg text-sm ${ts.input}`} title="Î∞òÎ≥µ ÏÑ§Ï†ï">
                                <option value="none">Î∞òÎ≥µ ÏóÜÏùå</option><option value="daily">Îß§Ïùº</option><option value="weekly">Îß§Ï£º</option><option value="monthly">Îß§Ïõî</option>
                                </select>
                            </div>
                        </div>
                        
                        <div className="flex flex-col md:flex-row gap-3">
                            <div className="flex-1 flex gap-2 items-center">
                            <div className={`flex-1 flex items-center border rounded-lg px-2 ${ts.input}`}>
                                <Hash className="w-4 h-4 text-slate-400 mr-1"/>
                                <input type="text" value={newTag} onChange={(e) => setNewTag(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddTag())} placeholder="ÌÉúÍ∑∏ ÏûÖÎ†• (Enter)" className="flex-1 p-2 bg-transparent focus:outline-none text-sm"/>
                            </div>
                            <div className="flex flex-wrap gap-1 max-w-[150px] overflow-hidden">
                                {tags.map(t => <span key={t} onClick={() => removeTag(t)} className={`text-[10px] px-1.5 py-0.5 rounded cursor-pointer bg-indigo-100 text-indigo-700`}>{t} x</span>)}
                            </div>
                            </div>
                            
                            <div className="flex justify-end items-center gap-2">
                            <div className="flex gap-2">
                                <button type="button" onClick={() => setShowTemplates(true)} className={`px-4 py-2 border rounded-lg text-sm font-medium flex items-center gap-2 ${ts.buttonSecondary}`}><Bookmark className="w-4 h-4"/> ÌÖúÌîåÎ¶ø</button>
                                <button type="button" onClick={saveAsTemplate} className={`px-4 py-2 border rounded-lg text-sm font-medium flex items-center gap-2 ${ts.buttonSecondary}`}><Copy className="w-4 h-4"/> Ï†ÄÏû•</button>
                            </div>
                            <button type="submit" className={`px-8 py-2 rounded-lg font-bold text-sm shadow-sm whitespace-nowrap flex items-center gap-1 ${ts.buttonPrimary}`}><Plus className="w-5 h-5"/> Îì±Î°ù</button>
                            </div>
                        </div>
                        </form>
                    )}
                    </div>

                    {/* Î¶¨Ïä§Ìä∏ ÌïÑÌÑ∞ */}
                    <div className="flex flex-wrap gap-2 items-center px-1 no-print">
                    <BarChart3 className="w-5 h-5 text-slate-500 mr-2" />
                    {[{ id: 'all', label: 'Ï†ÑÏ≤¥' }, { id: 'in_progress', label: 'ÏßÑÌñâ Ï§ë' }, { id: 'completed', label: 'ÏôÑÎ£å' }].map((f) => (
                        <button key={f.id} onClick={() => setFilter(f.id)} className={`px-3 py-1.5 text-sm rounded-full border transition-all ${filter === f.id ? 'bg-indigo-600 text-white border-indigo-600 shadow-sm' : ts.buttonSecondary}`}>{f.label}</button>
                    ))}
                    <button onClick={() => toggleSelectAll(processedTasks)} className="ml-auto text-xs text-slate-500 hover:text-indigo-600 underline">{selectedTaskIds.length === processedTasks.length && processedTasks.length > 0 ? 'Ï†ÑÏ≤¥ Ìï¥Ï†ú' : 'Ï†ÑÏ≤¥ ÏÑ†ÌÉù'}</button>
                    </div>

                    {/* --- MAIN VIEW (List Only) --- */}
                    <div className="space-y-6">
                    <div className="flex items-center gap-2 px-2 no-print">
                        <Layers className="w-4 h-4 text-slate-500" />
                        <span className={`text-sm font-bold ${ts.muted}`}>Í∑∏Î£πÌôî:</span>
                        {['none', 'category', 'status', 'priority'].map(g => (
                        <button key={g} onClick={() => setGroupBy(g)} className={`px-3 py-1 text-xs rounded-full border transition-all ${groupBy === g ? 'bg-slate-700 text-white border-slate-600' : ts.buttonSecondary}`}>{g === 'none' ? 'ÏóÜÏùå' : g === 'category' ? 'Ïπ¥ÌÖåÍ≥†Î¶¨' : g === 'status' ? 'ÏÉÅÌÉú' : 'Ïö∞ÏÑ†ÏàúÏúÑ'}</button>
                        ))}
                    </div>
                    
                    {Object.entries(groupedTasks).map(([groupName, groupTasks]) => (
                        <div key={groupName} className="space-y-2">
                        {groupBy !== 'none' && (
                            <div className="flex items-center gap-2 px-2 pt-2">
                            <div className={`h-px flex-1 ${theme==='dark'?'bg-slate-700':'bg-slate-300'}`}></div>
                            <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">{groupName} ({groupTasks.length})</span>
                            <div className={`h-px flex-1 ${theme==='dark'?'bg-slate-700':'bg-slate-300'}`}></div>
                            </div>
                        )}
                        
                        {groupTasks.length === 0 ? <div className={`text-center py-8 rounded-xl border border-dashed ${ts.card}`}><p className="text-slate-500 font-medium">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p></div> : 
                            groupTasks.map((task) => (
                            <div key={task.id} className={`relative group border transition-all duration-200 hover:shadow-md ${task.status==='completed' ? 'opacity-60' : ''} ${ts.card} p-2 rounded-md flex flex-col gap-2 ${selectedTaskIds.includes(task.id) ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : ''}`}>
                                {editingId === task.id ? (
                                /* ÏàòÏ†ï Ìèº */
                                <div className={`w-full p-3 rounded border shadow-inner flex flex-col gap-3 ${ts.card}`}>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <input type="text" value={editForm.text} onChange={(e) => setEditForm({...editForm, text: e.target.value})} className={`p-2 border rounded font-bold ${ts.input}`} />
                                    <div className="flex gap-2">
                                        <select value={editForm.category} onChange={(e) => setEditForm({...editForm, category: e.target.value})} className={`p-2 border rounded text-sm flex-1 ${ts.input}`}>{categories.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                        <select value={editForm.priority} onChange={(e) => setEditForm({...editForm, priority: e.target.value})} className={`p-2 border rounded text-sm flex-1 ${ts.input}`}><option value="high">ÎÜíÏùå</option><option value="medium">Ï§ëÍ∞Ñ</option><option value="low">ÎÇÆÏùå</option></select>
                                    </div>
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                    <span className={`text-xs ${ts.muted}`}>Î∞òÎ≥µ:</span>
                                    <select value={editForm.recurrence || 'none'} onChange={(e) => setEditForm({...editForm, recurrence: e.target.value})} className={`p-1 border rounded text-xs flex-1 ${ts.input}`}>
                                        <option value="none">ÏóÜÏùå</option><option value="daily">Îß§Ïùº</option><option value="weekly">Îß§Ï£º</option><option value="monthly">Îß§Ïõî</option>
                                    </select>
                                    </div>

                                    <div className={`flex gap-2 items-center p-2 rounded ${theme==='dark'?'bg-slate-700':'bg-slate-50'}`}>
                                        <Hash className="w-3 h-3 text-slate-400"/>
                                        <div className="flex flex-wrap gap-1 flex-1">
                                        {editForm.tags && editForm.tags.map(t => <span key={t} onClick={() => removeEditTag(t)} className={`text-[10px] border px-1 rounded cursor-pointer ${ts.buttonSecondary}`}>{t} x</span>)}
                                        <input type="text" value={editTagInput} onChange={(e) => setEditTagInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddEditTag())} placeholder="ÌÉúÍ∑∏ Ï∂îÍ∞Ä" className="bg-transparent text-xs focus:outline-none min-w-[60px]"/>
                                        </div>
                                    </div>
                                    
                                    <div className={`p-2 rounded ${theme==='dark'?'bg-slate-700':'bg-slate-50'}`}>
                                    <div className="text-xs font-bold mb-1">ÏÑúÎ∏åÌÉúÏä§ÌÅ¨ (ÎÇ¥Ïö© / ÏòàÏ†ïÏùº)</div>
                                    {editForm.subtasks && editForm.subtasks.map((s, index) => (
                                        <div key={s.id} className="flex items-center gap-1 text-xs mb-1">
                                        <input type="checkbox" checked={s.done} onChange={() => toggleSubtaskFromEdit(s.id)}/>
                                        <span className={`flex-1 ${s.done?'line-through':''}`}>{s.text}</span>
                                        <span className="text-[10px] text-slate-400">{s.targetDate}</span>
                                        <div className="flex items-center gap-0.5 ml-1">
                                            <button onClick={() => moveSubtask(s.id, -1)} className="text-slate-400 hover:text-indigo-600 p-0.5" disabled={index === 0} title="ÏúÑÎ°ú"><ArrowUp className="w-3 h-3"/></button>
                                            <button onClick={() => moveSubtask(s.id, 1)} className="text-slate-400 hover:text-indigo-600 p-0.5" disabled={index === editForm.subtasks.length - 1} title="ÏïÑÎûòÎ°ú"><ArrowDown className="w-3 h-3"/></button>
                                        </div>
                                        <button onClick={() => removeSubtaskFromEdit(s.id)} className="text-red-400 ml-1"><X className="w-3 h-3"/></button>
                                        </div>
                                    ))}
                                    <div className="flex gap-1 mt-1">
                                        <input type="text" value={newSubtaskText} onChange={(e)=>setNewSubtaskText(e.target.value)} placeholder="Ìï† Ïùº Ï∂îÍ∞Ä" className={`flex-[2] text-xs border rounded p-1 ${ts.input}`} onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addSubtaskToEdit())}/>
                                        <input type="date" value={editTagInput} onChange={(e) => setEditTagInput(e.target.value)} className={`flex-1 text-xs border rounded p-1 ${ts.input}`} />
                                        <button onClick={() => { if(newSubtaskText.trim()){ setEditForm({...editForm, subtasks: [...(editForm.subtasks||[]), {id:Date.now(), text:newSubtaskText, done:false, targetDate: editTagInput}]}); setNewSubtaskText(''); setEditTagInput(''); }}} className={`text-xs px-2 rounded ${ts.buttonSecondary}`}>Ï∂îÍ∞Ä</button>
                                    </div>
                                    </div>

                                    <div className="flex justify-end gap-2 mt-2">
                                    <button onClick={cancelEdit} className={`px-3 py-1.5 text-sm rounded flex items-center gap-1 ${ts.buttonSecondary}`}><X className="w-4 h-4"/> Ï∑®ÏÜå</button>
                                    <button onClick={saveEdit} className={`px-3 py-1.5 text-sm rounded flex items-center gap-1 ${ts.buttonPrimary}`}><Save className="w-4 h-4"/> Ï†ÄÏû•</button>
                                    </div>
                                </div>
                                ) : (
                                /* Ï°∞Ìöå Î∑∞ */
                                <>
                                    <div className={`flex items-start gap-4 w-full items-center`}>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => toggleExpand(task.id)} className={`p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition-transform ${expandedTaskIds.includes(task.id) ? 'rotate-90' : ''}`}><ChevronRight className="w-4 h-4 text-slate-500" /></button>
                                        <input type="checkbox" checked={selectedTaskIds.includes(task.id)} onChange={() => toggleSelectTask(task.id)} className="w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500" />
                                    </div>
                                    <div className="flex flex-col gap-2 mt-1 flex-shrink-0">
                                        <button onClick={() => changeStatus(task.id, task.status)} className="transition-colors hover:opacity-80">
                                        {task.status === 'completed' ? <CheckCircle2 className="w-6 h-6 text-indigo-500" /> : <Circle className={`w-6 h-6 ${ts.muted}`} />}
                                        </button>
                                    </div>
                                    <div className="flex-grow min-w-0" onDoubleClick={() => startEdit(task)}>
                                        <div className={`flex flex-col md:flex-row md:items-center justify-between gap-4`}>
                                            <div className="flex items-center gap-2 min-w-[30%]">
                                            <p className={`text-base font-bold truncate ${task.status === 'completed' ? 'text-slate-400 line-through' : ''}`}>{task.text}</p>
                                            {task.recurrence !== 'none' && <span className="flex items-center gap-1 text-[10px] text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100"><Repeat className="w-3 h-3"/> {task.recurrence}</span>}
                                            {task.tags && task.tags.map(t => <span key={t} className={`text-[9px] px-1.5 rounded bg-slate-100 text-slate-500`}>{t}</span>)}
                                            </div>
                                            <div className="flex items-center gap-2 text-xs">
                                            <span className={`px-2 py-0.5 rounded border font-medium ${task.priority==='high'?'text-red-500 border-red-200 bg-red-50':task.priority==='medium'?'text-amber-500 border-amber-200 bg-amber-50':'text-blue-500 border-blue-200 bg-blue-50'}`}>{task.priority}</span>
                                            <span className={`px-2 py-0.5 rounded border font-medium ${ts.buttonSecondary}`}>{task.category}</span>
                                            </div>
                                        </div>
                                        <div className={`flex flex-wrap items-center gap-x-4 gap-y-2 mt-2 text-xs ${ts.muted} mt-0 ml-auto`}>
                                            <span>{getDday(task.deadline)}</span>
                                            {getNextAction(task) && <span className="flex items-center gap-1 text-indigo-600 font-bold"><Play className="w-3 h-3"/> Next: {getNextAction(task)}</span>}
                                            {task.subtasks && task.subtasks.length > 0 && <span>{task.subtasks.filter(s=>s.done).length}/{task.subtasks.length} sub</span>}
                                            {task.comments && task.comments.length > 0 && <span>{task.comments.length} comment</span>}
                                        </div>
                                    </div>
                                    <div className="flex flex-col gap-1 items-center self-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => startEdit(task)} className="p-2 text-slate-400 hover:text-indigo-600 rounded"><Edit2 className="w-4 h-4" /></button>
                                        <button onClick={() => duplicateTask(task)} className="p-2 text-slate-400 hover:text-indigo-600 rounded" title="Î≥µÏ†ú"><Copy className="w-4 h-4" /></button>
                                        {task.status === 'completed' && !task.isArchived && <button onClick={() => toggleArchive(task.id)} className="p-2 text-slate-400 hover:text-amber-500 rounded" title="Î≥¥Í¥Ä"><Archive className="w-4 h-4" /></button>}
                                        {task.isArchived && <button onClick={() => toggleArchive(task.id)} className="p-2 text-slate-400 hover:text-green-500 rounded" title="Î≥µÍµ¨"><RefreshCw className="w-4 h-4" /></button>}
                                        <button onClick={() => deleteTask(task.id)} className="p-2 text-slate-400 hover:text-red-600 rounded"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                    </div>

                                    {/* Expanded Subtasks View */}
                                    {expandedTaskIds.includes(task.id) && (
                                    <div className={`ml-10 mt-2 p-3 rounded-lg border-l-4 border-indigo-200 ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-50'}`}>
                                        {task.subtasks && task.subtasks.length > 0 ? (
                                        <div className="space-y-1">
                                            {task.subtasks.map(sub => (
                                            <div key={sub.id} className="flex items-center gap-2 text-sm justify-between">
                                                <div className="flex items-center gap-2">
                                                <div onClick={() => toggleSubtaskDirect(task.id, sub.id)} className={`w-4 h-4 border rounded cursor-pointer flex items-center justify-center ${sub.done ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300 bg-white'}`}>
                                                    {sub.done && <Check className="w-3 h-3 text-white" />}
                                                </div>
                                                <span className={`${sub.done ? 'line-through text-slate-400' : ''}`}>{sub.text}</span>
                                                </div>
                                                {sub.targetDate && <span className={`text-xs px-2 py-0.5 rounded ${sub.targetDate === getTodayString() ? 'bg-red-100 text-red-600 font-bold' : 'bg-slate-100 text-slate-500'}`}>{sub.targetDate}</span>}
                                            </div>
                                            ))}
                                        </div>
                                        ) : <div className="text-xs text-slate-400">ÌïòÏúÑ ÏóÖÎ¨¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>}
                                        
                                        {task.comments && task.comments.length > 0 && (
                                        <div className="mt-3 pt-2 border-t border-dashed border-slate-300">
                                            <div className="text-xs font-bold text-slate-500 mb-1">ÏµúÍ∑º ÎåìÍ∏Ä</div>
                                            {task.comments.slice(-2).map(c => (
                                            <div key={c.id} className="text-xs mb-1"><span className="font-bold text-indigo-600">{c.author}:</span> <span>{c.text}</span></div>
                                            ))}
                                        </div>
                                        )}
                                    </div>
                                    )}
                                </>
                                )}
                            </div>
                            ))
                        }
                        </div>
                    ))}
                    </div>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
